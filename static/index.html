<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>TMPNOTES üî•Ô∏è</title>

    <!-- Bootstrap core CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Custom styles for this template -->
    <link href="custom.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"
        integrity="sha512-E8QSvWZ0eCLGk4km3hxSsNmGWbLtSCSUcewDQPQWZF6pEU8GlT8a5fF32wOl1i8ftdMhssTrF/OhyGWwonTcXA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body class="py-4">
    <div class="container">

        <h1><a href="/" style="text-decoration: none; color: inherit;">TMPNOTES üî•Ô∏è</a></h1>
        <p class="lead">Temporary notes that disappear after reading</p>

        <h2>Note:</h2>
        <div class="row">
            <div class="col-lg-9">
                <label for="notes-input">Maximum 512 characters allowed</label>
                <textarea class="form-control" id="notes-input" rows="7" maxlength="512"></textarea>
            </div>
            <div class="col">
                <div class="row">
                    <br>Hours before disappearing<br>
                    <select class="custom-select" id="hours-input">
                        <option>1</option>
                        <option>2</option>
                        <option>3</option>
                        <option>4</option>
                        <option>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option>8</option>
                        <option>9</option>
                        <option>10</option>
                        <option>11</option>
                        <option>12</option>
                        <option>13</option>
                        <option>14</option>
                        <option>15</option>
                        <option>16</option>
                        <option>17</option>
                        <option>18</option>
                        <option>19</option>
                        <option>20</option>
                        <option>21</option>
                        <option>22</option>
                        <option>23</option>
                        <option>24</option>
                    </select>
                </div>
                <div class="row">
                    <br>
                    <button type="submit" id="send-button" class="btn btn-primary btn-block"
                        onclick="postInfo()">Send</button>
                </div>
            </div>
        </div>
        <div class="row" id="encrypt-row">
            <div class="col-lg-9">
                <div class="form-group">
                    <label for="enc-key">
                        <h3>Optional encryption key</h3>(encrypt your message before sending it to the
                        server)
                    </label>
                    <input type="password" class="form-control" id="enc-key" placeholder="Your passphrase here">
                </div>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="row">
            <div class="col-lg-9">
                <div class="form-group">
                    <input type="text" class="form-control mt-1" id="note-id"
                        style="visibility: hidden; text-align: center;" readonly>
                </div>
            </div>
            <div class="col-lg d-grid">
                <button type="submit" id="copy-button" class="btn btn-primary mb-2 btn-block mt-1" onclick="copyLink()"
                    style="visibility: hidden;">copy</button>
            </div>
        </div>
    </div>
</body>

</html>


<script>
    const input = document.getElementById('notes-input');
    const maxChars = 512
    document.addEventListener('keydown', countInput);
    document.addEventListener('keyup', countInput);

    function countInput(e) {
        input.labels[0].innerText = input.textLength + "/" + maxChars
    }

    async function postInfo() {
        var e = document.getElementById("hours-input");
        var hours = e.options[e.selectedIndex].text;
        var e = document.getElementById("notes-input");
        var key = document.getElementById("enc-key");
        var note = encryptNote(e.value, key.value);
        e.readOnly = true;
        document.getElementById("send-button").style.visibility = "hidden";
        var data = { "message": note, "expire": parseInt(hours) }
        var opts = {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }

        var req = new Request(location.origin + "/new", opts)

        await fetch(req).then(function (response) {
            return response.text().then(function (text) {
                e = document.getElementById("note-id");
                e.value = location.origin + "/id/" + text;
            });
        })
            .catch(error => {
                console.log('request failed', error);
                alert("Unable to reach the server. Try again later.")
                throw error;
            });

        e = document.getElementById("note-id");
        e.style.visibility = "visible";
        document.getElementById("copy-button").style.visibility = "visible";
        document.getElementById("encrypt-row").remove();
    }

    function copyLink() {
        let noteid = document.getElementById("note-id");
        noteid.select();
        document.execCommand('copy');
    }

    // encrypt the note if an encryption key is provided
    function encryptNote(note, key) {
        if (key.length > 0) {
            var ciphertext = CryptoJS.AES.encrypt(note, key);
            return "[ENC]" + ciphertext.toString()
        } else {
            return note;
        }
    }
</script>